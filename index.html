<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Covid no Brasil</title>
    <!-- Load c3.css -->
    <link href="c3.min.css" rel="stylesheet">

    <!-- Load d3.js and c3.js -->
    <script src="d3.min.js" charset="utf-8"></script>
    <script src="c3.min.js"></script>
    <style>
        body {
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .container {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 90%;
        }
        #graficoCasosConfirmados {
            width: 100%;
        }
        #graficoCasosConfirmadosPorSemana {
            width: 100%;
        }
        /*.c3-line {
            stroke-width: 3px;
        }
        .c3-circle {
            stroke-width: 5px !important;
            stroke: rgb(31, 119, 180);;
        }*/
    </style>
</head>
<body>
    <div id="container-confirmados" class="container">
        <h3>Casos Confirmados</h3>
        <div id="graficoCasosConfirmados"></div>
    </div>

    <div id="container-confirmados-semana" class="container">
        <h3>Casos Confirmados Por Semana</h3>
        <div id="graficoCasosConfirmadosPorSemana"></div>
    </div>

    <!-- A api nÃ£o esta funcionando com as mortes-->
    <!--<div id="container-mortes" class="container">
        <h3>Mortes</h3>
        <div id="graficoMortes"></div>
    </div>-->
    <script>
        Date.prototype.getWeek = function() {
            var date = new Date(this.getTime());
            date.setHours(0, 0, 0, 0);
            date.setDate(date.getDate() + 3 - (date.getDay() ) % 7);
            var week1 = new Date(date.getFullYear(), 0, 4);
            return 1 + Math.round(((date.getTime() - week1.getTime()) / 86400000
                                    - 3 + (week1.getDay() ) % 7) / 7);
        }
        const calcMS = (response, ms, i) => {
            if(i >= ms) {
                let resp = 0
                for(let ii = i - ms; ii <= i; ii++) {
                    resp += response.dias[ii].casosNovos
                }
                return resp / ms
            }
            return 0
        }
        const calcMSSemana = (response, ms, i) => {
            if(i >= ms) {
                let resp = 0
                for(let ii = i - ms; ii <= i; ii++) {
                    resp += response.semana[ii].casosNovos
                }
                return resp / ms
            }
            return 0
        }
        const calcMME2 = (response, mme, i, valor) => {
            if(i >= mme) {
                const atual = calcMS(response, mme, i)
                const k = 2 / (mme + 1)
                let resp = (atual - response.dias[i - 1].mme[mme])*k + response.dias[i - 1].mme[mme]
                return resp
            }
            return 0
        }
        const calcMME2Semana = (response, mme, i, valor) => {
            if(i >= mme) {
                const atual = calcMSSemana(response, mme, i)
                const k = 2 / (mme + 1)
                let resp = (atual - response.semana[i - 1].mme[mme])*k + response.semana[i - 1].mme[mme]
                return resp
            }
            return 0
        }
        const calcMME = (response, mme, i, valor) => {
            if(i >= mme) {
                const k = 2 / (mme + 1)
                let resp = valor * k + (response.dias[i - 1].mme[mme] ? response.dias[i - 1].mme[mme] : 0) * (1 - k)
                return resp
            }
            return 0
        }
        const calcMMESemana = (response, mme, i, valor) => {
            if(i >= mme) {
                const k = 2 / (mme + 1)
                let resp = valor * k + (response.semana[i - 1].mme[mme] ? response.semana[i - 1].mme[mme] : 0) * (1 - k)
                return resp
            }
            return 0
        }
        var xhttp = new XMLHttpRequest();
        var graficoConfirmados;
        var graficoConfirmadosPorSemana;
        xhttp.onreadystatechange = function() {
            if (this.readyState == 4 && this.status == 200) {
                var resposta = JSON.parse(this.responseText)
                for(let i = 0; i < resposta.dias.length; i++) {
                    resposta.dias[i].mme = []
                    resposta.dias[i].mme[7] = calcMME(resposta, 7, i, resposta.dias[i].casosNovos)
                    resposta.dias[i].mme[17] = calcMME(resposta, 17, i, resposta.dias[i].casosNovos)
                    resposta.dias[i].mme[72] = calcMME(resposta, 72, i, resposta.dias[i].casosNovos)
                }
                graficoConfirmados = c3.generate({
                    bindto: '#graficoCasosConfirmados',
                    data: {
                        columns: [
                            ['MME 7', ...resposta.dias.map(o => o.mme[7])],
                            ['MME 17', ...resposta.dias.map(o => o.mme[17])],
                            ['MME 72', ...resposta.dias.map(o => o.mme[72])],
                            ['Diario', ...resposta.dias.map(o => o.casosNovos)]
                        ],
                        types: {
                            Diario: 'bar' 
                        }
                    },
                    onresized: function () {
                        window.innerWidth > 800 ? graficoConfirmados.internal.config.axis_x_tick_culling_max = 999 : graficoConfirmados.internal.config.axis_x_tick_culling_max = 5;
                        graficoConfirmados.resize();
                    }
                });
                for(let i = 0; i < resposta.semana.length; i++) {
                    resposta.semana[i].mme = []
                    resposta.semana[i].mme[7] = calcMMESemana(resposta, 7, i, resposta.semana[i].casosNovos)
                    resposta.semana[i].mme[17] = calcMMESemana(resposta, 17, i, resposta.semana[i].casosNovos)
                    resposta.semana[i].mme[72] = calcMMESemana(resposta, 72, i, resposta.semana[i].casosNovos)
                }
                graficoConfirmadosPorSemana = c3.generate({
                    bindto: '#graficoCasosConfirmadosPorSemana',
                    data: {
                        columns: [
                            ['MME 7', ...resposta.semana.map(o => o.mme[7])],
                            ['MME 17', ...resposta.semana.map(o => o.mme[17])],
                            ['MME 72', ...resposta.semana.map(o => o.mme[72])],
                            ['Semanal', ...resposta.semana.map(o => o.casosNovos)],
                        ],
                        types: {
                            Semanal: 'bar' 
                        }
                    },
                    onresized: function () {
                        graficoConfirmadosPorSemana.resize();
                    }
                });
            }
        };
        xhttp.open("GET", "https://xx9p7hp1p7.execute-api.us-east-1.amazonaws.com/prod/PortalCasos", true);
        xhttp.send();
    </script>
</body>
</html>